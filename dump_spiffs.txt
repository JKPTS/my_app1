

===== FILE: spiffs\index.html =====
SIZE: 2413 bytes | LASTWRITE: 2025-12-31T01:54:56.2727667+07:00
----- BEGIN CONTENT -----
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Footswitch MIDI Setup</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <h1>Footswitch MIDI Setup</h1>

  <section class="card">
    <h2>Live State</h2>
    <div class="row">
      <div>Bank: <span id="curBank">0</span></div>
      <div>Page: <span id="curPage">0</span></div>
    </div>
    <div class="row">
      <button id="btnBankMinus">Bank - (5&6)</button>
      <button id="btnPagePlus">Page + (6&7)</button>
      <button id="btnBankPlus">Bank + (7&8)</button>
    </div>
    <div id="stateMsg" class="msg"></div>
  </section>

  <section class="card">
    <h2>Edit Mapping</h2>

    <div class="row">
      <label>Bank
        <select id="selBank"></select>
      </label>
      <label>Page
        <select id="selPage"></select>
      </label>
      <label>Button
        <select id="selBtn"></select>
      </label>
    </div>

    <div class="row">
      <label>Press Mode
        <select id="pressMode">
          <option value="0">Short only</option>
          <option value="1">Short + Long</option>
        </select>
      </label>

      <label>CC Behavior
        <select id="ccBehavior">
          <option value="0">Normal CC</option>
          <option value="1">Toggle CC</option>
          <option value="2">Momentary CC</option>
        </select>
      </label>
    </div>

    <h3>Short Actions (macro)</h3>
    <div id="shortList"></div>
    <button id="addShort">+ Add Short Action</button>

    <h3>Long Actions (macro)</h3>
    <div id="longList"></div>
    <button id="addLong">+ Add Long Action</button>

    <div class="row">
      <button id="btnSave">Save to ESP32</button>
      <button id="btnReload">Reload from ESP32</button>
    </div>
    <div id="saveMsg" class="msg"></div>
  </section>

  <section class="card">
    <h2>Action Types (แนะนำเพิ่ม)</h2>
    <ul>
      <li>CC, PC, Note On/Off ✅</li>
      <li><b>Bank Select + PC</b> (CC0 + CC32 + PC) ⭐</li>
      <li>Delay ใน macro (เช่น 20ms) ⭐</li>
      <li>NRPN/RPN (advanced)</li>
      <li>Pitch Bend / Aftertouch (advanced)</li>
      <li>MIDI Clock / Start / Stop (Tap tempo)</li>
      <li>SysEx (เฉพาะค่าย, advanced)</li>
    </ul>
  </section>

  <script src="/app.js"></script>
</body>
</html>


----- END CONTENT -----

===== FILE: spiffs\app.js =====
SIZE: 5157 bytes | LASTWRITE: 2025-12-31T01:54:56.5280604+07:00
----- BEGIN CONTENT -----
let CFG = null;
const $ = (id)=>document.getElementById(id);

function fillSelect(sel, n, prefix=""){
  sel.innerHTML = "";
  for(let i=0;i<n;i++){
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = prefix + i;
    sel.appendChild(opt);
  }
}

function mkActionRow(action, onRemove){
  const row = document.createElement("div");
  row.className = "action";

  const type = document.createElement("select");
  ["cc","pc","note","delay","bank_pc"].forEach(t=>{
    const o=document.createElement("option"); o.value=t; o.textContent=t; type.appendChild(o);
  });
  type.value = action.type || "cc";

  const ch = document.createElement("input"); ch.type="number"; ch.min=1; ch.max=16; ch.value = action.ch ?? 1;
  const a  = document.createElement("input"); a.type="number"; a.min=0; a.max=127; a.value = action.a ?? 0;
  const b  = document.createElement("input"); b.type="number"; b.min=0; b.max=127; b.value = action.b ?? 0;
  const c  = document.createElement("input"); c.type="number"; c.min=0; c.max=255; c.value = action.c ?? 0;

  const rm = document.createElement("button"); rm.textContent="X";
  rm.onclick = ()=>onRemove(row);

  row.append(type,ch,a,b,c,rm);
  row._get = ()=>({
    type: type.value,
    ch: Number(ch.value||1),
    a: Number(a.value||0),
    b: Number(b.value||0),
    c: Number(c.value||0),
  });
  return row;
}

function renderActions(listEl, actions){
  listEl.innerHTML = "";
  actions.forEach(act=>{
    const row = mkActionRow(act, (r)=>r.remove());
    listEl.appendChild(row);
  });
}

function collectActions(listEl){
  const rows = [...listEl.querySelectorAll(".action")];
  return rows.map(r=>r._get());
}

function getSelectedMap(){
  const bank = Number($("selBank").value);
  const page = Number($("selPage").value);
  const btn  = Number($("selBtn").value);
  return CFG.banks[bank].pages[page].buttons[btn];
}

function applyUIFromMap(m){
  $("pressMode").value = m.pressMode;
  $("ccBehavior").value = m.ccBehavior;
  renderActions($("shortList"), m.short);
  renderActions($("longList"), m.long);
}

function writeMapFromUI(m){
  m.pressMode = Number($("pressMode").value);
  m.ccBehavior = Number($("ccBehavior").value);
  m.short = collectActions($("shortList"));
  m.long  = collectActions($("longList"));
}

async function apiGet(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiPost(url, obj){
  const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(obj)});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function loadConfig(){
  CFG = await apiGet("/api/config");
  $("saveMsg").textContent = "Loaded config";
  applyUIFromMap(getSelectedMap());
}

async function saveConfig(){
  const m = getSelectedMap();
  writeMapFromUI(m);

  const r = await fetch("/api/config", {method:"POST", body: JSON.stringify(CFG)});
  if(!r.ok) throw new Error(await r.text());
  $("saveMsg").textContent = "Saved ✅";
}

async function pollState(){
  try{
    const st = await apiGet("/api/state");
    $("curBank").textContent = st.bank;
    $("curPage").textContent = st.page;
  }catch(e){}
  setTimeout(pollState, 500);
}

function setup(){
  fillSelect($("selBank"), 20, "Bank ");
  fillSelect($("selPage"), 4, "Page ");
  fillSelect($("selBtn"), 8, "Btn ");
  $("selBtn").value = 0;

  $("selBank").onchange = ()=>applyUIFromMap(getSelectedMap());
  $("selPage").onchange = ()=>applyUIFromMap(getSelectedMap());
  $("selBtn").onchange  = ()=>applyUIFromMap(getSelectedMap());

  $("pressMode").onchange = ()=>writeMapFromUI(getSelectedMap());
  $("ccBehavior").onchange = ()=>writeMapFromUI(getSelectedMap());

  $("addShort").onclick = ()=>{
    const m = getSelectedMap();
    m.short.push({type:"cc",ch:1,a:0,b:0,c:0});
    applyUIFromMap(m);
  };

  $("addLong").onclick = ()=>{
    const m = getSelectedMap();
    m.long.push({type:"cc",ch:1,a:0,b:0,c:5});
    applyUIFromMap(m);
  };

  $("btnSave").onclick = async ()=>{
    try { await saveConfig(); }
    catch(e){ $("saveMsg").textContent = "Save failed: " + e.message; }
  };

  $("btnReload").onclick = async ()=>{
    try { await loadConfig(); }
    catch(e){ $("saveMsg").textContent = "Reload failed: " + e.message; }
  };

  // Live state controls
  $("btnBankMinus").onclick = async ()=>{
    const st = await apiGet("/api/state");
    await apiPost("/api/state", {bank: Math.max(0, st.bank-1), page: st.page});
    $("stateMsg").textContent = "Bank -";
  };

  $("btnBankPlus").onclick = async ()=>{
    const st = await apiGet("/api/state");
    await apiPost("/api/state", {bank: Math.min(19, st.bank+1), page: st.page});
    $("stateMsg").textContent = "Bank +";
  };

  $("btnPagePlus").onclick = async ()=>{
    const st = await apiGet("/api/state");
    await apiPost("/api/state", {bank: st.bank, page: (st.page+1)%4});
    $("stateMsg").textContent = "Page +";
  };
}

window.addEventListener("load", async ()=>{
  setup();
  try { await loadConfig(); }
  catch(e){ $("saveMsg").textContent = "Load failed: " + e.message; }
  pollState();
});


----- END CONTENT -----

===== FILE: spiffs\style.css =====
SIZE: 675 bytes | LASTWRITE: 2025-12-31T01:54:56.3084766+07:00
----- BEGIN CONTENT -----
body { font-family: system-ui, Arial; margin: 16px; }
.card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
.row { display: flex; gap: 10px; flex-wrap: wrap; margin: 8px 0; }
label { display: flex; flex-direction: column; gap: 6px; }
button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
button:hover { background: #eee; }
.msg { margin-top: 8px; color: #0a6; }
.action { display: grid; grid-template-columns: 120px 70px 70px 70px 70px 50px; gap: 6px; align-items: center; margin: 6px 0; }
.action input, .action select { padding: 6px; }
.small { font-size: 12px; color: #555; }


----- END CONTENT -----
